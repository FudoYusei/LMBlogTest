---
layout: post
title: Computer Graphics (六) 手动实现软渲染-切向量空间
subtitle: 难以理解的切向量空间
author: LM
categories: 图形渲染
# banner:
#   # video: https://vjs.zencdn.net/v/oceans.mp4
#   #loop: true
#   #volume: 0.8
#   #start_at: 8.5
#   image: /assets/images/banners/FlipModel.png
#   opacity: 0.8
#   background: "#000"
#   height: "50vh"
#   min_height: "38vh"
#   heading_style: "font-size: 4.25em; font-weight: bold; text-decoration: underline"
#   subheading_style: "color: gold"
excerpt_image: /assets/images/banners/FlipModel.png
tags: 图形渲染
priority: 6
---

![banner](/assets/images/banners/ComputerGraphics/Projection.png)  

如果只是使用顶点法向量来进行光照计算, 那么对于尺寸小于三角形面片的细节都会丢失, 法向量贴图和纹理贴图一样都是补充三角形面片内部的细节.  

切向量空间的定义和解释很多, 但是依然很难理解. 如果能准确回答下面几个问题, 说明充分的理解了切向量空间的本质:  
1. 切向量空间的作用? 为什么需要切向量空间以及为什么会被称为切向量空间?
2. 切向量空间的使用方法?
3. 顶点法向量怎么得到? 顶点切向量怎么得到? 
4. 切向量空间是顶点空间? 切向量空间和顶点空间的关系
5. 切向量空间中作为基向量的法向量和切向量基于哪个空间
6. 为什么会对切向量与法向量正交化, 这样不会导致向量空间失真吗?

## 切向量空间
切向量空间与法向量贴图的资料很多, 简单来说, 在着色器中通过对于法向量贴图的采样, 得到对应像素点的法向量, 从而实现额外的光照效果.  

<span style='color:#4cd137'>从法向量贴图中采样获取的向量值, 并不是世界坐标系的法向量, 而是切向量空间中的法向量</span>  

切向量空间是顶点空间, 通常切向量空间的基向量都是基于对象空间的坐标, 所以切向量空间的矩阵就是切向量空间转换到对象空间的矩阵.  



## 切向量空间的使用方法
切向量空间当然不是凭空产生的, 渲染流程中的光照效果基于顶点法向量进行计算. 就像纹理贴图可以给三角形采样颜色一样, 也可以给三角形采样法向量.  


### 高度图
高度图, 顾名思义就是让三角形采样顶点高度, 不同的高度差代表凹凸程度, 例如一个坑坑洼洼的墙面, 实际上就是表面的高度差形成了不同的法向量.  

> 3D 建模软件中拥有各种挤压工具, 可以形成凹凸的表面

通常从高度图中计算得到对应的凹凸图(法向量贴图), 想象高度图贴在三角形面片上, 此时三角形面片上建立了一个空间坐标系,  <span style='color:#4cd137'>以高度贴图的 s t 轴正方向以及三角形面片的法向量三个基向量建立的坐标系, 这个就是切向量空间.</span> 同时也可以看出切向量空间是以一个三角形面片为基础单位建立的.  
  
根据高度图计算三角形某一点的法向量, 在该点处沿着s t 轴正方向分别计算对应采样位置 <i,j> 两条切向量:  
$$ S(i,j) = <1, 0, H(i + 1, j) - H(i-1, j)> $$  
$$ T(i,j) = <0, 1, H(i, j + 1) - H(i, j - 1)> $$  
根据两个切向量可以求出对应的法向量:  
$$ N(i,j) = \frac{S(i, j) \times T(i,j)}{S(i, j) \times T(i, j)} $$  

<span style='color:#4cd137'>注意, 这里并没有说 st 轴需要与顶点法向量正交, 而是在 st 轴方向上利用高度差求出切向量, 求出来的切向量与扰动法向量正交, 高度差是一个绝对值, 并不是 st 轴组成的向量</span>  

N(i, j) 就是凹凸图存储的扰动法向量. <span style='color:#4cd137'>之所以称为扰动法向量是因为, 切向量空间的 z 轴正方向规定为顶点法向量, 因为基于这个顶点法向量调整生成的扰动法向量. 切向量规定为 s t 轴正方向与顶点法向量正交的向量</span>  

假如该点没有高度差, 那么双切线为 <1, 0, 0> <0, 1, 0> 扰动法向量为<0, 0 , 1>, 也就是没有扰动, <span style='color:#4cd137'>从这里可以看出切向量空间的 z 轴正方向<0, 0, 1> 实际上可以随意定义, 不一定是三角形面计算得到的法向量, 不需要严格垂直于三角形面</span>, 双切线也不是严格 st 轴, 只是正反向一致. 因为扰动法向量通常不会太偏移, 法向量与 st 轴接近于正交.  

轴 <1, 0, 0> 和 <0, 1, 0> 并不是 st 轴, 而是切向量的 x y 轴, 只要保证与 st 轴正方向一致  

可以这么理解:  
1. 现在有一个模型, 需要给模型添加光照效果, 光照效果需要顶点法向量, 原始光照效果就是由顶点法向量计算得出的.
2. 为了添加更多的光照细节, 需要给模型添加法向量贴图.
3. 建模师基于原始光照效果进行调整, 也就是基于原始法向量获得新的法向量(扰动法向量)
4. 模型顶点已经具有一个由原始顶点法向量为基准的切向量空间(顶点空间). 只要存储扰动法向量在切向量空间中的坐标即可  

总结来说, 扰动法向量不是凭空产生的, 而是基于原始法向量的基础调整出来:  
1. 原始法向量可以直接从顶点数据中获取, <span style='color:#4cd137'>因此以顶点原始法向量作为 z 轴建立切向量空间</span>.   
2. 纹理坐标也是可以直接从顶点数据中获取, 通过顶点坐标和纹理坐标, 可以求出在对象空间中与纹理 st 轴对齐的 TB 轴.  

> 顶点法向量和贴图的两个轴是并不是一定正交, 三角形面会在展 uv 的过程中平铺在纹理贴图上.
> 三角形面可能会经过拉伸变换, 所以空间坐标系的 st 轴不一定互相垂直.
> 顶点法向量不一定与三角形面垂直, st 轴一定处于三角形面中, 所以顶点法向量也不一定与 st 轴垂直.
> 保证顶点法向量相同, 再以顶点法向量正交化出 st 轴正方向的切向量.

<span style='color:#fbc531'>总觉得这个正交化有点问题</span>  


### 凹凸图
凹凸图(法向量贴图) 中存储的并不是可以直接使用的法向量. 想象高度图贴在三角形上, 此时利用高度差计算出来的法向量实际是三角形的扰动法向量.   

### 光照计算
<span style='color:#4cd137'>光照位置需要从世界空间转换到切向量空间中才能与扰动法向量进行计算. </span>  

这也是为什么要让切向量矩阵正交化的原因, 方便求逆矩阵.   

## 顶点法向量与切向量
顶点法向量的计算很简单, 因为模型都是由三角形组成的, 顶点法向量就是这些三角形面的法向量.  

### 顶点法向量
三角形面偏中的顶点法向量的计算过程:  
$ \vec{N} = \frac{(\vec{P}_1 - \vec{P}_0) \times (\vec{P}_2-\vec{P}_0)}{\|(\vec{P}_1 - \vec{P}_0)\times(\vec{P}_2 - \vec{P}_0)\|} $  

因为顶点处于对象空间中, 顶点坐标是对象空间的坐标, 显然计算出来的法向量也是处于对象空间中. <span style='color:#4cd137'>顶点坐标 法向量 切向量都是默认处于对象空间的坐标</span>  

<span style='color:#4cd137'>这里涉及到叉乘, 所以需要记录顶点空间的偏手性, 与对象空间的偏手性相反记为 -1, 因为后续要在对象空间中进行叉乘</span>  
  

> 建模软件中的 Smooth 功能应该就是通过计算共面的点的平均法向量达成的, 让共面的边缘处更加柔和.   

<span style='color:#fbc531'>常见的 Cube 模型的法向量是不是平均法向量?</span>  
对于这种要表达边缘感的点, 一般会在顶点数据中存储顶点法向量. 例如, 使用 RenderDoc 查看 3D Cube 的 Mesh 数据, 但是, 随之而来的问题就是: 发现相同坐标的点, 法向量不同. 那么相同坐标的点会被多次渲染吗? 几个未经验证的猜想:   
1. 将相同位置的点视为同一个共同顶点, 平均计算它的所有法向量, 将所有法向量相加, 再除以总长度.  
2. 视为独立的顶点, 对于相同位置的顶点有着特殊的渲染方式.
3. 视为独立的顶点, 并且没有特殊的渲染方式, 因为共点的像素数量相对于整体来说非常少, 没有多少影响

### 顶点切向量
一个面的切向量有无数个, 所以我们才需要制定一个统一的标准, 这样才能在不同工作流之间通用.  

顶点切向量指的是切向量空间的两个切向量, 并不是求扰动法向量时的扰动切向量  

## 顶点空间
顶点空间是定义在顶点的坐标系的统称, 任何基于顶点的基向量组成的空间都可以称为顶点空间.  

例如, 随便指定三个正交的基向量 <0, 0, 1> <0, 1, 0> <1, 0, 0> 作为顶点空间. 任意一个正交的坐标系都是这三个基向量. (因为缺少了真正的基向量 $ \vec{i} \vec{j} \vec{k} $)  

切向量空间实际上就是在顶点处正交的三个基向量构成的顶点空间, 就像我们定义世界坐标系时, 定义 z 轴正方向为 Up, x 轴正方向为 Right, 这些都是人为规定的标准. 定义了标准后, 才能在不同的坐标系之间进行转换.  
Up Right Front 这种方向型可以认为代表了三个向量  

> 这点可以在建模软件中得到证实, 建模软件导出 3D 建模, 可以在导出时选择不同标准的坐标系.

<span style='color:#4cd137'>切向量空间就是人为规定的一个标准, 以顶点法向量为 z 轴正方向, 在纹理坐标 st 轴正方向获取两个切线作为另外两个基向量</span>  

## 切向量空间计算
为三角形三个顶点构造切向量矩阵, 用于光照计算时的向量转换. 类似于对象空间向世界空间转换矩阵, 使用基向量组成转换矩阵.  

现在, 需要获取切向量空间的三个基向量在对象空间中的映射坐标.  

### 顶点法向量
第一个基向量就是顶点法向量, 顶点法向量可以由模型数据求出, 也可以直接附加在顶点数据中, 本身就是基于对象空间的坐标  

### 顶点切向量
计算顶点切向量的过程就是复原生成凹凸图时的切向量空间中的两个与 st 正方向相同的切向量轴.  
<span style='color:#4cd137'>注意, 这个是切向量轴, 而不是扰动切向量</span>  

<span style='color:#4cd137'>无论在顶点(切向量)空间还是对象空间中, 有两个东西是相同的, 一个是原始顶点法向量, 同一个向量作为 z 轴, 另一个是纹理坐标, 用于求出 st 轴, 再进一步求出与法向量正交的切向量轴</span>  
    
设置 $ \vec{T} $ 和 $ \vec{B} $ 为三角形面中与纹理图对齐的切向量. <span style='color:#4cd137'>这个切向量是三角形面的切向量, 并不是最终顶点切向量, 用于指明切向量正方向, 后续正交化做准备</span>  

三角形三个顶点 $ P_0 $ $ P_1 $ $ P_2 $, 分别对应纹理坐标$ (s_0, t_0) $, $ (s_1, t_1) $, $ (s_2, t_2) $. 假设 Q 是三角形面内一点, 纹理坐标为(s,t), 从面的切向量与纹理坐标(s,t)的关系可得:  
$$ Q - \vec{P}_0 = (s-s_0)\vec{T} + (t-t_0)\vec{B}  $$  

具体证明过程参考 3D 游戏数学方法切向量空间一节. 最终可以求出 $ \vec{T} $ 和 $ \vec{B} $.   

<span style='color:#4cd137'>施密特规范化求出顶点法向量在 $ \vec{T} $ 和 $ \vec{B} $ 同向的正交切向量 $ \vec{T}^{'} $ 和 $ \vec{B}^{'} $</span>  

三个向量共同组成顶点的切向量空间. 存储顶点切向量空间不会存储三个向量, 顶点法向量一般存储在顶点数据中, 因此只需要存储一个切向量, 另一个切向量使用叉乘可以得到. <span style='color:#fbc531'>貌似两个向量就能代替三个向量?</span>  
  

<span style='color:#4cd137'>涉及到叉乘肯定就会有偏手性相关的问题, 三个向量可以计算得到偏手性是否与对象空间一致</span>  
举例来说, 切向量空间的三个基向量在对象空间的坐标表示为:  
$$ \vec{N} = (0, 0, 1) $$  
$$ \vec{T} = (1, 0, 0) $$  
$$ \vec{B} = (0, -1, 0) $$  
这三个向量组成的切向量空间与对象空间相反(并不是说 -1 就是左手坐标系, 只是两者相反)  
令 w = $ \vec{N} \times \vec{T} \cdot \vec{B} $, 即偏手性标志  

> st 轴正方向作为切线方向是为了切向量空间偏手性不发生改变
> 如果纹理坐标发生翻转, 那么切向量空间偏手性可能会发生改变, 因此顶点切向量的 w 值作为偏手性标志
